---
description: "MANDATORY development process - read SOURCE_OF_TRUTH.md, search before creating, verify with evidence, auto-review"
alwaysApply: true
---

# Mandatory Process

## PHASE 1: Before Writing Code

### 1. READ SOURCE_OF_TRUTH.md FIRST
Before any code work, read `docs/SOURCE_OF_TRUTH.md`. It contains:
- 10 Cardinal Rules (violating them WILL cause bugs)
- Anti-patterns by category
- Existing service locations
- Component registry

**Output:** "üìñ Checked SOURCE_OF_TRUTH.md: [relevant rules/patterns found]"

### 2. SEARCH BEFORE CREATING (CRITICAL - Prevents Tech Debt)

**NEVER create a new file without searching first.** Duplicative code is the #1 source of tech debt.

| Creating... | Search These Locations | Look For |
|-------------|------------------------|----------|
| Component | `components/`, `components/ui/` | Similar name or purpose |
| Hook | `hooks/`, `lib/hooks/` | Same functionality |
| Utility | `lib/`, `lib/*Service.js` | Same calculation or transform |
| API route | `app/api/` | Same endpoint pattern |
| Style | `styles/`, existing component CSS | Same visual pattern |

**Search Commands:**
```bash
# Search by name pattern
glob "**/*[keyword]*"

# Search by functionality
grep "function.*[keyword]" --type js
grep "export.*[keyword]" --type js
```

**STOP if you find existing code.** Extend or import it instead of duplicating.

**Output:** "üîç Searched [locations]: [found X - will reuse / nothing found - creating new]"

---

## PHASE 2: After Writing Code

### 3. AUTO-REVIEW (Virtual Design Team)

**After completing any code change, automatically invoke the appropriate reviewer:**

| Change Type | Auto-Invoke | What It Checks |
|-------------|-------------|----------------|
| Any code change | `code-reviewer` subagent | Cardinal Rules, security, patterns |
| UI/component work | `ui-reviewer` subagent | Design system, accessibility, touch targets |
| Bug fix | `debugger` subagent | Root cause verified, no regressions |
| New functionality | `test-writer` subagent | Test coverage needed |

**This is automatic, not optional.** The reviewer subagent runs after substantive changes.

### 4. VERIFY WITH EVIDENCE
Every task must end with proof it works:
- State success criteria
- Run verification (grep, lint, test, file check)
- Show actual output

**Output:** "‚úÖ Verified: [evidence]"

---

## Task Routing

| Task Type | Approach | Auto-Review |
|-----------|----------|-------------|
| **Simple fix** | Do it directly | ‚Üí `code-reviewer` |
| **New feature** | `@feature-workflow` | ‚Üí `code-reviewer` + `ui-reviewer` |
| **Bug/debugging** | `@debug-workflow` | ‚Üí `debugger` |
| **UI work** | Build it | ‚Üí `ui-reviewer` |
| **Before shipping** | `@review-workflow` | ‚Üí Full review |

---

## Cardinal Rules Quick Reference

1. **car_id for queries** - Resolve slug with `resolveCarId()` first
2. **Design tokens** - Use `var(--color-*)`, never hardcode hex
3. **Touch targets** - 44px minimum (`h-11`)
4. **Tier gating** - Respect `tierAccess` config
5. **Skeleton loaders** - Not spinners for data fetches
6. **Domain-specific names** - Not `handleClick`, `formatData`

## Key Service Files (Check Before Creating New)

| Need | Existing File | DON'T Create |
|------|---------------|--------------|
| Car resolution | `lib/carResolver.js` | Another car lookup |
| Car data | `lib/carsClient.js` | Another car fetch |
| User data | `lib/userDataService.js` | Another user query |
| Performance calcs | `lib/performanceCalculator/` | Another HP calculator |
| Errors | `lib/apiErrors.js` | Another error handler |
| Auth | `lib/auth.js` | Another auth check |
| Images | `lib/images.js` | Another image util |
| Validation | `lib/schemas/` | Another validator |
