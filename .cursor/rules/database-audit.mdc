# Database Integrity & Optimization Audit

Use this rule when asked to audit or verify the database structure.

## Audit Checklist

### 1. Identifier Consistency (car_slug vs car_id)

Run these queries to find violations:

```sql
-- Tables using car_slug WITHOUT car_id (should be zero)
SELECT table_name, column_name
FROM information_schema.columns
WHERE column_name = 'car_slug'
  AND table_schema = 'public'
  AND table_name NOT IN (
    SELECT table_name FROM information_schema.columns
    WHERE column_name = 'car_id' AND table_schema = 'public'
  );

-- Rows with car_slug but NULL car_id (data integrity issue)
SELECT 'community_insights' as tbl, COUNT(*) FROM community_insights WHERE car_slug IS NOT NULL AND car_id IS NULL
UNION ALL SELECT 'car_dyno_runs', COUNT(*) FROM car_dyno_runs WHERE car_slug IS NOT NULL AND car_id IS NULL
UNION ALL SELECT 'car_track_lap_times', COUNT(*) FROM car_track_lap_times WHERE car_slug IS NOT NULL AND car_id IS NULL
UNION ALL SELECT 'document_chunks', COUNT(*) FROM document_chunks WHERE car_slug IS NOT NULL AND car_id IS NULL
UNION ALL SELECT 'vehicle_maintenance_specs', COUNT(*) FROM vehicle_maintenance_specs WHERE car_slug IS NOT NULL AND car_id IS NULL
UNION ALL SELECT 'vehicle_service_intervals', COUNT(*) FROM vehicle_service_intervals WHERE car_slug IS NOT NULL AND car_id IS NULL;
```

**Rule**: All tables with `car_slug` MUST also have `car_id`. Code MUST query by `car_id` (resolved once from slug).

### 2. Missing Foreign Key Indexes

```sql
-- Find FK columns without indexes
SELECT
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage ccu
    ON tc.constraint_name = ccu.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
  AND NOT EXISTS (
    SELECT 1 FROM pg_indexes
    WHERE tablename = tc.table_name
      AND indexdef LIKE '%' || kcu.column_name || '%'
  );
```

### 3. Orphaned Records

```sql
-- Records referencing non-existent cars
SELECT 'car_issues' as tbl, COUNT(*) FROM car_issues ci
  WHERE ci.car_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM cars c WHERE c.id = ci.car_id)
UNION ALL SELECT 'car_dyno_runs', COUNT(*) FROM car_dyno_runs dr
  WHERE dr.car_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM cars c WHERE c.id = dr.car_id)
UNION ALL SELECT 'community_insights', COUNT(*) FROM community_insights ci
  WHERE ci.car_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM cars c WHERE c.id = ci.car_id)
UNION ALL SELECT 'car_tuning_profiles', COUNT(*) FROM car_tuning_profiles tp
  WHERE tp.car_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM cars c WHERE c.id = tp.car_id);
```

### 4. Duplicate Data Detection

```sql
-- Duplicate car slugs (should be zero)
SELECT slug, COUNT(*) FROM cars GROUP BY slug HAVING COUNT(*) > 1;

-- Duplicate issues per car
SELECT car_id, title, COUNT(*) 
FROM car_issues 
GROUP BY car_id, title 
HAVING COUNT(*) > 1;

-- Duplicate tuning profiles per car
SELECT car_id, COUNT(*) 
FROM car_tuning_profiles 
GROUP BY car_id 
HAVING COUNT(*) > 1;
```

### 5. Auto-Populate Triggers Verification

```sql
-- Tables that MUST have auto_car_id triggers
SELECT t.table_name,
       CASE WHEN tg.trigger_name IS NOT NULL THEN '✓' ELSE '✗ MISSING' END as has_trigger
FROM (
  VALUES ('community_insights'), ('car_dyno_runs'), ('car_track_lap_times'),
         ('document_chunks'), ('vehicle_maintenance_specs'), ('vehicle_service_intervals')
) AS t(table_name)
LEFT JOIN information_schema.triggers tg 
  ON tg.event_object_table = t.table_name 
  AND tg.trigger_name LIKE 'auto_car_id%';
```

### 6. RPC Function Verification

```sql
-- Required RPC functions
SELECT proname, 
       CASE WHEN proname IS NOT NULL THEN '✓' ELSE '✗ MISSING' END
FROM pg_proc
WHERE proname IN (
  'get_car_ai_context',
  'get_car_ai_context_v2',
  'get_car_tuning_context',
  'get_car_maintenance_summary',
  'resolve_car_id_from_slug'
);
```

### 7. Deprecated Tables/Columns Check

These should NOT be used in new code:
- `vehicle_known_issues` → Use `car_issues`
- `cars.upgrade_recommendations` → Use `car_tuning_profiles.upgrades_by_objective`
- `cars.popular_track_mods` → Use `car_tuning_profiles.upgrades_by_objective`

```bash
# Search codebase for deprecated usage
rg "vehicle_known_issues" --type js --type jsx -l
rg "upgrade_recommendations" --type js --type jsx -l
rg "popular_track_mods" --type js --type jsx -l
```

## Code Pattern Verification

### Correct Pattern (use car_id)
```javascript
// ✓ CORRECT: Resolve once, use car_id
const carId = await resolveCarId(carSlug);
const { data } = await supabase
  .from('car_issues')
  .select('*')
  .eq('car_id', carId);
```

### Incorrect Pattern (avoid)
```javascript
// ✗ WRONG: Direct car_slug query
const { data } = await supabase
  .from('car_issues')
  .select('*')
  .eq('car_slug', carSlug);

// ✗ WRONG: OR clause (kills index usage)
.or(`car_id.eq.${carId},car_slug.eq.${carSlug}`)
```

### Files to Check for car_slug Direct Usage
```bash
# Should return minimal results (only URL parsing, not DB queries)
rg "\.eq\('car_slug'" lib/ app/ components/ --type js
rg "car_slug.*=" lib/ app/ components/ --type js -g '!*.test.js'
```

## Source of Truth Matrix

| Data Type | Source Table | NOT These |
|-----------|-------------|-----------|
| Known Issues | `car_issues` | `vehicle_known_issues` |
| Upgrade Recommendations | `car_tuning_profiles.upgrades_by_objective` | `cars.upgrade_recommendations` |
| Track Mods | `car_tuning_profiles.upgrades_by_objective` | `cars.popular_track_mods` |
| Maintenance Specs | `vehicle_maintenance_specs` | - |
| Service Intervals | `vehicle_service_intervals` | - |
| Dyno Data | `car_dyno_runs` | - |
| Lap Times | `car_track_lap_times` | - |

## How to Run This Audit

1. Run all SQL queries via Supabase MCP `execute_sql`
2. Run codebase searches via `rg` commands
3. Report any violations found
4. Propose fixes for each violation

## Expected Results (Healthy Database)

- Zero tables with car_slug but no car_id column
- Zero rows with car_slug but NULL car_id
- Zero orphaned records
- Zero duplicate slugs/profiles
- All required triggers present
- All required RPC functions present
- Minimal car_slug direct queries in code (only URL parsing)
