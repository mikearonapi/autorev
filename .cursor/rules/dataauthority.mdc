---
alwaysApply: true
---
# Data Authority Rules

## Source of Truth Hierarchy
1. **DATABASE.md** - Canonical schemas, tables, columns
2. **API.md** - Response shapes and API contracts
3. **database-patterns.mdc** - Code patterns and table usage

## Cardinal Rules

1. **NEVER invent tables** - Check DATABASE.md and query `information_schema.tables` first
2. **NEVER invent columns** - Query existing schema before adding fields
3. **NEVER duplicate data** - One source of truth per data type (see database-patterns.mdc)
4. **ALWAYS use car_id** - Never query by car_slug directly (use lib/carResolver.js)

## Before Writing Database Code

```
STOP and verify:
1. Does this table exist? → Check DATABASE.md or query schema
2. Does this column exist? → Check DATABASE.md or query schema  
3. Am I using the right table? → Check source of truth matrix in database-patterns.mdc
4. Am I querying by car_id? → Must resolve slug first via resolveCarId()
```

## Key Patterns

- **Car lookups**: `lib/carResolver.js` → `resolveCarId(slug)`
- **Complex car data**: Use RPC `get_car_ai_context_v2(slug)` 
- **Tuning data**: Use RPC `get_car_tuning_context(slug)`
- **Known issues**: Query `car_issues` table (NOT vehicle_known_issues)
- **Upgrades**: Query `car_tuning_profiles.upgrades_by_objective` (NOT cars.upgrade_recommendations)

## If Data Doesn't Exist

1. Propose schema changes with rationale
2. Check if existing table can be extended
3. Never fabricate data or columns
4. Update DATABASE.md if changes are made