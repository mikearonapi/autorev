---
description: Core development workflow - search first, minimal changes, no duplication
globs: ["**/*"]
alwaysApply: true
---

# CORE DEVELOPMENT WORKFLOW

## MANDATORY: Search Before Creating

Before writing ANY code, you MUST:

1. **Search the codebase** for existing implementations
2. **Search the docs/** folder for relevant standards
3. **Present findings** before proposing solutions

Use these search patterns:
- Functions/utilities: Search `lib/`, `hooks/`
- Components: Search `components/`
- Hooks: Search `hooks/`, `lib/hooks/`
- Types: Search `types/`
- API routes: Search `app/api/`
- Services: Search `lib/*Service.js`, `lib/*Client.js`

## The 4-Step Process (NO EXCEPTIONS)

1. **UNDERSTAND** - Restate the goal, identify affected areas
2. **RESEARCH** - Search codebase + docs, find existing patterns
3. **PLAN** - Propose approach using existing code, wait for approval
4. **BUILD** - Implement with minimal changes

## Source of Truth Documents

**PRIMARY REFERENCE - Read This First:**
- `docs/SOURCE_OF_TRUTH.md` â€” **CANONICAL reference for the entire codebase**

**What SOURCE_OF_TRUTH.md Contains:**
- ðŸ” **AI Quick Search Index** â€” Keyword lookup to find relevant sections fast
- âš ï¸ **10 Cardinal Rules** â€” Critical rules that prevent 90% of bugs
- **Anti-Patterns Section** â€” Common mistakes organized by category (database, components, state, API)
- **File Relationships Map** â€” Service dependencies and data flow diagrams
- **"I need to..." Quick Reference** â€” Task-based lookup table
- Service locations, component registry, hook reference

**Domain-Specific Docs:**

| Document | Use When |
|----------|----------|
| `docs/SOURCE_OF_TRUTH.md` | **ALWAYS check first** - contains everything |
| `docs/DATABASE.md` | Tables, schemas, relationships |
| `docs/BRAND_GUIDELINES.md` | Colors, typography, brand identity |
| `docs/CSS_ARCHITECTURE.md` | Design tokens, styling patterns |
| `docs/AL.md` | AI assistant features, tool usage |
| `docs/TIER_ACCESS_MATRIX.md` | Feature gating by subscription tier |
| `docs/API.md` | API routes, response shapes |
| `docs/ARCHITECTURE.md` | Overall system design |

**Best Practices (Deep-Dive Reference):**

| Document | Use When |
|----------|----------|
| `docs/Best Practices/Design System & Mobile-First UX.md` | Touch targets, accessibility, loading states, form UX |
| `docs/Best Practices/Analytics and Observability.md` | Event tracking, metrics, error monitoring |
| `docs/Best Practices/Subscription and Monetization.md` | Payment webhooks, subscription state |
| `docs/Best Practices/AI Feature Development Standards.md` | RAG, prompts, tool design for AL |
| `docs/Best Practices/Production Grade Cross Platform App Development Standards.md` | TypeScript config, testing, security |

## Anti-Duplication Rules

1. **NEVER create a new utility** without searching `lib/` first
2. **NEVER create a new component** without checking `components/`
3. **NEVER create a new hook** without searching `hooks/` and `lib/hooks/`
4. **NEVER add a dependency** without checking if existing deps solve it
5. **If you find existing code** â†’ Reuse > Extend > Refactor > Create

## Key Service Files (Check These First!)

| Need | Check This File |
|------|-----------------|
| Car data | `lib/carsClient.js`, `lib/carResolver.js` |
| User data | `lib/userDataService.js` |
| **Performance/HP calculations** | `lib/performanceCalculator/` **(SOURCE OF TRUTH)** |
| Tuning profiles | `lib/tuningProfiles.js` |
| Maintenance | `lib/maintenanceService.js` |
| Events | `lib/eventsService.js` |
| YouTube | `lib/youtubeClient.js` |
| Articles | `lib/articlesService.js` |
| AI/AL features | `lib/alTools.js`, `lib/alConversationService.js` |
| Parts/fitment | `lib/fitmentService.js`, `lib/fitmentResolver.js` |
| Analytics | `lib/activityTracker.js`, `lib/ga4.ts` |
| Errors | `lib/errorLogger.js`, `lib/apiErrors.js` |
| Auth | `lib/auth.js`, `lib/adminAuth.js` |
| Stripe/billing | `lib/stripe.js` |
| Images | `lib/images.js`, `lib/imageUploadService.js` |

## Naming Conventions (MANDATORY)

Consistent naming prevents duplication and makes code searchable:

| Type | Convention | Example | Anti-Pattern |
|------|------------|---------|--------------|
| **Components** | PascalCase | `UserProfileCard.jsx` | `userProfileCard.jsx` |
| **Hooks** | camelCase + `use` prefix | `useUserProfile.js` | `userProfile.js` |
| **Utilities** | camelCase, verb-first | `formatVehiclePrice.js` | `utils.js`, `helpers.js` |
| **Services** | camelCase + `Service` suffix | `userDataService.js` | `userData.js` |
| **API routes** | kebab-case folders | `app/api/user-profile/` | `app/api/userProfile/` |
| **CSS modules** | PascalCase matching component | `UserProfileCard.module.css` | `styles.module.css` |

**Function Names Must Be Domain-Specific:**

```javascript
// âœ… CORRECT: Searchable, domain-specific
const handleVehicleProfileUpdate = () => {};
const calculatePerformanceGain = (stock, modified) => {};
const formatMaintenanceDate = (date) => {};

// âŒ WRONG: Generic, easily duplicated
const handleClick = () => {};
const calculate = (a, b) => {};
const formatData = (data) => {};
```

## Code Quality Standards

- Prefer modification over creation
- Prefer composition over duplication
- Prefer explicit over implicit
- Prefer small, focused changes
- Match existing patterns in surrounding code
- **Use domain-specific names** (not generic `handleClick`, `formatData`)

## Communication Protocol

- State "Searching for: [what]" before searching
- State "Found: [summary]" after searching
- State "Applying rules from: [which docs]" before implementing
- Challenge my ideas if you see better approaches
- Don't apologize - just fix and explain

## Verification Protocol

Before marking ANY task complete:
1. STATE the success criteria explicitly
2. RUN verification (query, grep, file check)
3. SHOW the evidence in response
4. Only THEN mark complete

**No verification = Not complete. No exceptions.**
