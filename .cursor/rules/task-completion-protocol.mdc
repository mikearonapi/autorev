# Task Completion Protocol

> **CRITICAL**: This rule defines the mandatory process for completing ANY task. Skipping steps is NOT acceptable. Speed is secondary to correctness.

---

## The 5-Step Completion Protocol

Every task MUST follow these 5 steps. No exceptions.

### Step 1: DEFINE (Before Starting)

Before writing any code, explicitly state:

```
TASK: [What needs to be done]
SUCCESS CRITERIA:
- [ ] Specific, measurable outcome 1
- [ ] Specific, measurable outcome 2
- [ ] ...
VERIFICATION METHOD: [How I will prove it worked]
```

**Rules:**
- Success criteria must be MEASURABLE (counts, existence checks, specific values)
- Never use vague criteria like "update scripts" - list EACH script by name
- If a task affects the database, define the expected row counts or states

### Step 2: IMPLEMENT (Do the Work)

Execute the implementation. This is the coding/changes step.

**Rules:**
- Work through each success criterion one at a time
- Don't batch multiple unrelated changes
- If you discover the scope is larger than expected, STOP and redefine

### Step 3: VERIFY (Prove It Worked)

Run verification queries/checks for EACH success criterion.

**Database changes:**
```sql
-- Always verify with actual queries
SELECT COUNT(*) FROM table WHERE condition;
-- Check for expected state, not just "no errors"
```

**File changes:**
```bash
# Verify files exist AND contain expected content
grep -n "expected_pattern" path/to/file
```

**Script integrations:**
```bash
# Verify BOTH import AND usage
grep -n "import.*module" script.js
grep -n "actualFunctionUsed" script.js
```

**Rules:**
- NEVER assume it worked - PROVE it worked
- If verification fails, go back to Step 2
- Document the verification result

### Step 4: REPORT (State What Was Done)

After verification passes, state:

```
COMPLETED: [Task name]
VERIFIED:
- ✅ Criterion 1: [evidence]
- ✅ Criterion 2: [evidence]
```

**Rules:**
- Only report AFTER verification passes
- Include specific evidence (row counts, line numbers, etc.)
- Never say "done" without evidence

### Step 5: MOVE ON (Only After Steps 1-4)

Only mark a todo as complete and move to the next task AFTER:
- All success criteria verified
- Evidence documented
- No outstanding issues

---

## Anti-Patterns to AVOID

### ❌ "Updated all scripts"
Never claim "all X" without explicitly listing each X.

**Wrong:**
> Updated all ingestion scripts to use validation layer

**Right:**
> Updated 4 scripts to use validation layer:
> - seedLapTimesFastestLaps.mjs (line 17: import, line 95: usage)
> - seedDynoRunsEstimated.mjs (line 19: import, line 78: usage)
> - ingest-affiliate-feed.mjs (line 29: import, line 216: usage)
> - recategorizeParts.mjs (line 21: import, line 186: usage)
> 
> NOT updated (validation not applicable):
> - expandFitments.mjs (uses different validation pattern)

### ❌ Marking complete before verifying
Never mark a todo complete until you've run verification.

**Wrong:**
```
[writes migration file]
"Migration complete, marking todo done"
```

**Right:**
```
[writes migration file]
[applies migration]
[runs verification query]
"Verified: table has 2,767 rows, all foreign keys valid. Marking complete."
```

### ❌ Assuming schema/structure
Never assume a column/table exists without checking.

**Wrong:**
```sql
-- Adding trigger that references car_slug
CREATE TRIGGER auto_resolve ON my_table...
```

**Right:**
```sql
-- First, verify the column exists
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'my_table' AND column_name = 'car_slug';

-- Only then create trigger if column exists
```

### ❌ Batching unverified work
Never mark multiple things complete without individual verification.

**Wrong:**
> Completed P1 tasks: validation layer, pipeline updates, triggers, data fix

**Right:**
> P1-1 Validation layer: ✅ verified (447 lines, exports 5 functions)
> P1-2 Pipeline updates: ✅ verified (4/4 scripts have imports AND usage)
> P1-3 Triggers: ❌ ISSUE FOUND - tables lack car_slug column
> P1-4 Data fix: ✅ verified (0 NULL car_id remaining)

---

## Todo Creation Rules

When creating todos for a complex task:

1. **Break into verifiable units** - Each todo should have ONE clear verification
2. **Include the verification in the todo** - e.g., "Add X (verify with Y)"
3. **List specific files/tables** - Never use vague references
4. **Estimate scope honestly** - If unsure, investigate first

**Example - Good todos:**
```
- [ ] Create lib/dataValidation.js with validateCarReference function
      Verify: file exists, exports validateCarReference
- [ ] Update seedLapTimes.mjs to import and use validateCarReference
      Verify: grep shows import on line X, usage on line Y
- [ ] Update seedDynoRuns.mjs to import and use validateCarReference
      Verify: grep shows import on line X, usage on line Y
- [ ] Fix 68 community_insights with NULL car_id
      Verify: SELECT COUNT(*) WHERE car_id IS NULL = 0
```

**Example - Bad todos:**
```
- [ ] Create validation layer
- [ ] Update all scripts
- [ ] Fix data issues
```

---

## When in Doubt

If uncertain about:
- **Schema**: Query `information_schema` first
- **Scope**: List every item explicitly, then ask user to confirm
- **Completion**: Run one more verification query
- **Impact**: Check for dependencies before changing

**The rule is simple: PROVE IT, DON'T ASSUME IT.**

---

## Checklist Before Marking Any Task Complete

```
□ Did I define success criteria BEFORE starting?
□ Did I verify EACH criterion with actual evidence?
□ Did I document the verification results?
□ If I said "all X", did I list every X explicitly?
□ If database change, did I run a COUNT/SELECT to verify?
□ If file change, did I verify the file exists AND has correct content?
□ Am I 100% confident this is done, or am I hoping it's done?
```

If any answer is "no" or uncertain → DO NOT mark complete.
