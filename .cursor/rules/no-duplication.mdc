---
alwaysApply: true
---
# No Duplication Rule (MECE Principle)

**CRITICAL:** Before creating ANY new file, function, component, or pattern, you MUST search for existing implementations. This codebase follows the MECE principle: Mutually Exclusive, Collectively Exhaustive.

## Cardinal Rules

1. **NEVER create a new file without searching first** - Use grep/glob to find similar files
2. **NEVER duplicate functionality** - Extend or modify existing code instead
3. **NEVER create parallel implementations** - One source of truth per feature
4. **ALWAYS ask "Does this already exist?"** - The answer is often YES

## Mandatory Pre-Creation Checklist

Before creating ANYTHING, complete this checklist:

```
STOP and search:
1. File exists?      → Glob for similar names
2. Function exists?  → Grep for similar logic
3. Component exists? → Check components/ directory
4. Service exists?   → Check lib/ directory
5. Type exists?      → Check types/ directory
6. Style exists?     → Check styles/ and *.module.css
```

## Search Commands (Run These First!)

### Before Creating a New Component
```bash
# Search by name pattern
glob "**/*{keyword}*.jsx"
glob "**/*{keyword}*.tsx"

# Search for similar functionality
grep -r "similar function name or pattern" components/
```

### Before Creating a New Service/Utility
```bash
# Check lib/ directory first
ls lib/
grep -r "functionName" lib/

# Search for similar patterns
grep -r "export.*{keyword}" lib/
```

### Before Creating a New API Route
```bash
# Check existing routes
ls app/api/
grep -r "similar endpoint" app/api/
```

### Before Creating a New Type/Interface
```bash
# Check types directory
ls types/
grep -r "interface {Name}" types/
grep -r "type {Name}" types/
```

## Codebase Organization (Know Where Things Live)

| Category | Location | Before Creating, Check... |
|----------|----------|---------------------------|
| Components | `components/` | Similar UI patterns |
| Services | `lib/` | Similar data operations |
| Types | `types/` | Existing interfaces |
| API Routes | `app/api/` | Existing endpoints |
| Hooks | `lib/hooks/` | Custom hooks |
| Utilities | `lib/` | Helper functions |
| Styles | `styles/` | Shared CSS |
| Database | `lib/*Service.js` | Existing DB operations |

## Key Service Files (Check These First!)

Before creating data-related code, these files likely already have what you need:

| Need | Check This File |
|------|-----------------|
| Car data | `lib/carsClient.js`, `lib/carResolver.js` |
| User data | `lib/userDataService.js` |
| Tuning/upgrades | `lib/tuningProfiles.js`, `lib/upgradeCalculator.js` |
| Maintenance | `lib/maintenanceService.js` |
| Events | `lib/eventsService.js` |
| YouTube | `lib/youtubeClient.js` |
| Articles | `lib/articlesService.js` |
| AI/AL features | `lib/alTools.js`, `lib/alConversationService.js` |
| Parts/fitment | `lib/fitmentService.js`, `lib/fitmentResolver.js` |
| Analytics | `lib/activityTracker.js`, `lib/ga4.ts` |
| Errors | `lib/errorLogger.js`, `lib/apiErrors.js` |
| Auth | `lib/auth.js`, `lib/adminAuth.js` |
| Stripe/billing | `lib/stripe.js` |
| Images | `lib/images.js`, `lib/imageUploadService.js` |

## Common Duplication Mistakes

### ❌ Creating a new "helper" file
```javascript
// DON'T create lib/myNewHelpers.js
// DO extend existing relevant service file
```

### ❌ Creating a duplicate component
```javascript
// DON'T create NewCarCard.jsx if CarCard.jsx exists
// DO extend CarCard.jsx with new props/variants
```

### ❌ Creating a parallel service
```javascript
// DON'T create lib/vehicleService.js when lib/carsClient.js exists
// DO add methods to the existing service
```

### ❌ Creating duplicate types
```typescript
// DON'T define Car interface in multiple files
// DO import from central types/ location
```

### ❌ Creating one-off CSS
```css
/* DON'T create inline styles or new CSS files for common patterns */
/* DO use styles/components/ or compose from existing modules */
```

## When You CAN Create New Files

Only create a new file when ALL of these are true:

1. ✅ You've searched and confirmed nothing similar exists
2. ✅ The functionality is genuinely new and distinct
3. ✅ It cannot be added to an existing file without bloating it
4. ✅ It follows the established directory structure
5. ✅ It doesn't overlap with existing responsibilities

## If You Find Similar Code

When you find existing code that's close to what you need:

1. **Extend it** - Add new parameters, options, or methods
2. **Refactor it** - Make it more flexible to handle your use case
3. **Compose it** - Build on top of existing functionality
4. **DON'T duplicate it** - Never copy-paste and modify

## Quick Decision Tree

```
Need to create something new?
│
├─ Search for existing implementation
│  ├─ Found exact match? → USE IT
│  ├─ Found similar? → EXTEND IT
│  └─ Found nothing? → Continue...
│
├─ Can it be added to existing file?
│  ├─ Yes, file < 500 lines → ADD TO EXISTING
│  └─ No, file too large → Continue...
│
├─ Is this truly unique functionality?
│  ├─ Yes → CREATE NEW (document why)
│  └─ No → RE-SEARCH (you missed something)
│
└─ CREATE NEW FILE
   └─ Follow directory conventions
   └─ Update relevant docs
```

## Enforcement

If you're about to create a new file, STOP and:

1. Run the search commands above
2. List what you searched for
3. Explain why existing code won't work
4. Only then proceed with creation

**No searching = No creating. No exceptions.**
