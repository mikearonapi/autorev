# AutoRev Codebase Audit - December 14, 2024

> âš ï¸ **SUPERSEDED:** Many issues from this morning audit have been resolved. See `DOCS_SYNC_REPORT_2024-12-14.md` for current status.

## Audit Overview

| Attribute | Value |
|-----------|-------|
| **Date Started** | 2024-12-14 |
| **Status** | âœ… Complete (superseded by evening sync) |
| **Auditor** | AI-Assisted |
| **Scope** | Full codebase audit |

---

## Phase Tracking

| Phase | Description | Status | Findings |
|-------|-------------|--------|----------|
| 1A | Internal Link Verification | âœ… Complete | 2 broken, 1 suspicious |
| 1B | API Route Verification | âš ï¸ Issues Found | 1 critical, 13 undocumented |
| 2A | Import/Export Health | âœ… Complete | 2 deprecated refs, 2 TODOs |
| 2B | Database Schema Alignment | âš ï¸ Issues Found | 2 undocumented tables, 2 doc mismatches |
| 3A | Parts Catalog Integration | âœ… Complete | All flows verified |
| 3B | AL Tools Verification | âœ… Complete | All 15 tools verified |
| 4 | Cron & Background Jobs | âœ… Complete | 2 auth gaps, 1 doc mismatch |
| 5 | Security & Auth Review | â³ Pending | - |
| 6 | Performance Analysis | â³ Pending | - |
| 7 | Test Coverage Assessment | â³ Pending | - |
| 8 | Documentation Sync | â³ Pending | - |

---

## Findings Summary

### Critical Issues
<!-- Issues that require immediate attention -->

| ID | Issue | Location | Impact |
|----|-------|----------|--------|
| CRIT-001 | `/api/cars` route does not exist | 5 internal pages | Internal tools broken |

### High Priority
<!-- Issues that should be addressed soon -->

| ID | Issue | Location | Impact |
|----|-------|----------|--------|
| HIGH-001 | Broken link `/cars/${slug}` | `app/internal/qa/page.jsx:127` | 404 on click |
| HIGH-002 | Broken link `/cars/${slug}` | `app/garage/compare/page.jsx:163` | 404 on click |
| HIGH-003 | API.md says GET but code is POST | `/api/parts/relationships` | Doc mismatch |
| HIGH-004 | DATABASE.md `part_relationships` columns wrong | `docs/DATABASE.md:152` | Doc mismatch |
| HIGH-005 | DATABASE.md `document_chunks` column wrong | `docs/DATABASE.md:318` | Doc mismatch |
| HIGH-006 | youtube-enrichment cron missing x-vercel-cron check | `app/api/cron/youtube-enrichment/route.js:47` | Auth bypass risk |

### Medium Priority
<!-- Issues to address in normal development cycle -->

| ID | Issue | Location |
|----|-------|----------|
| MED-001 | 13 API methods undocumented | See Phase 1B details |
| MED-002 | `upgrade_education` table not in DATABASE.md | Used in `lib/educationData.js` |
| MED-003 | `car_known_issues` table not in DATABASE.md | Used in `lib/alTools.js` |
| MED-004 | âœ… Reference to deleted `SOURCE_OF_TRUTH.md` | `docs/OWNER_GUIDE.md` - Fixed |
| MED-005 | âœ… Reference to deleted `docs/data-model.md` | `docs/OWNER_GUIDE.md`, `supabase/schema.sql` - Fixed |
| MED-006 | API.md cron schedules don't match vercel.json | `docs/API.md:406-410` |
| MED-007 | process-scrape-jobs POST missing x-vercel-cron check | `app/api/cron/process-scrape-jobs/route.js:79` |

### Low Priority / Tech Debt
<!-- Nice-to-have improvements -->

| ID | Issue | Location |
|----|-------|----------|
| LOW-001 | Anchor link unverified | `/encyclopedia#systems` in PerformanceHub.jsx |
| LOW-002 | TODO: Remove deprecated exports | `lib/userDataService.js:385` |
| LOW-003 | TODO: Integrate Exa API | `lib/alTools.js:1427` |

---

## Phase 1A: Internal Link Verification

**Status:** âœ… Complete  
**Scanned:** 33 files (13 in app/, 20 in components/)  
**Routes Found:** 24 unique routes

### Valid Routes

| Route | Reference Count | Sample Locations |
|-------|-----------------|------------------|
| `/` | 8 | Footer.jsx, Header.jsx, auth/error/page.jsx, not-found.jsx |
| `/browse-cars` | 5 | Footer.jsx, mod-planner/page.jsx, CompareBar.jsx |
| `/browse-cars/${slug}` | 5 | CarActionMenu.jsx, CompareModal.jsx, browse-cars/[slug]/page.jsx |
| `/car-selector` | 9 | Footer.jsx, Header.jsx, page.jsx, join/page.jsx, not-found.jsx |
| `/garage` | 7 | Footer.jsx, Header.jsx, mod-planner/page.jsx, PerformanceHub.jsx |
| `/garage/compare` | 1 | (implicit via app/garage/compare/) |
| `/tuning-shop` | 8 | Footer.jsx, Header.jsx, contact/page.jsx, BuildsWorkshop.jsx |
| `/mod-planner` | 1 | (implicit via app/mod-planner/) |
| `/encyclopedia` | 4 | Footer.jsx, Header.jsx, PerformanceHub.jsx, MobileBottomCta.jsx |
| `/profile` | 5 | Header.jsx (multiple), MobileBottomCta.jsx |
| `/contact` | 8 | Footer.jsx, ScoringInfo.jsx (6), PerformanceHub.jsx |
| `/privacy` | 2 | Footer.jsx (via legalLinks), privacy/page.jsx |
| `/terms` | 2 | Footer.jsx (via legalLinks), terms/page.jsx |
| `/join` | 4 | Header.jsx (multiple), AIMechanicChat.jsx |
| `/join?upgrade=${tier}` | dynamic | tierAccess.js:208 (generated) |
| `/auth/error` | 1 | (implicit via app/auth/error/) |
| `/internal` | 1 | (implicit via app/internal/) |
| `/internal/qa` | 1 | internal/page.jsx |
| `/internal/knowledge` | 1 | internal/page.jsx |
| `/internal/parts-review` | 1 | internal/page.jsx |
| `/internal/lap-times` | 1 | internal/page.jsx |
| `/internal/dyno` | 1 | internal/page.jsx |
| `/internal/variant-maintenance` | 1 | internal/page.jsx |
| `/internal/feedback` | 1 | (page exists: app/internal/feedback/) |
| `/internal/manual-entry` | 1 | (page exists: app/internal/manual-entry/) |

### âš ï¸ Broken Routes

| Route | Location | Issue | Fix |
|-------|----------|-------|-----|
| `/cars/${car.slug}` | `app/internal/qa/page.jsx:127` | Route does not exist | Change to `/browse-cars/${car.slug}` |
| `/cars/${car.slug}` | `app/garage/compare/page.jsx:163` | Route does not exist | Change to `/browse-cars/${car.slug}` |

### Suspicious Patterns

| Pattern | Location | Concern |
|---------|----------|---------|
| `/encyclopedia#systems` | `components/PerformanceHub.jsx:1592` | Anchor may not exist on target page |

### Navigation Arrays Verified

| Component | Links Array | Status |
|-----------|-------------|--------|
| Header.jsx | `navLinks` (6 items) | âœ… All valid |
| Footer.jsx | `mainLinks` (6 items) | âœ… All valid |
| Footer.jsx | `legalLinks` (2 items) | âœ… All valid |
| MobileBottomCta.jsx | `pageCtas` (5 configs) | âœ… All valid |
| internal/page.jsx | `TOOLS` (6 items) | âœ… All valid |

---

## Phase 1B: API Route Verification

**Status:** âš ï¸ Issues Found  
**Routes in API.md:** 37  
**Routes in Code:** 37 route files  
**Undocumented Methods:** 13  
**Critical Issues:** 1

### Route Inventory

#### Car Data Routes (15 documented, 15 implemented)

| Route | Doc Method | Impl Methods | Status |
|-------|------------|--------------|--------|
| `/api/cars/[slug]/efficiency` | GET | GET | âœ… Match |
| `/api/cars/[slug]/safety-ratings` | GET | GET | âœ… Match |
| `/api/cars/[slug]/price-by-year` | GET | GET | âœ… Match |
| `/api/cars/[slug]/market-value` | GET | GET | âœ… Match |
| `/api/cars/[slug]/lap-times` | GET | GET | âœ… Match |
| `/api/cars/[slug]/dyno` | GET | GET | âœ… Match |
| `/api/cars/[slug]/maintenance` | GET | GET | âœ… Match |
| `/api/cars/[slug]/expert-reviews` | GET | GET | âœ… Match |
| `/api/cars/[slug]/expert-consensus` | GET | GET | âœ… Match |
| `/api/cars/[slug]/enriched` | GET | GET | âœ… Match |
| `/api/cars/[slug]/safety` | GET | GET | âœ… Match |
| `/api/cars/[slug]/fuel-economy` | GET | GET | âœ… Match |
| `/api/cars/[slug]/pricing` | GET | GET | âœ… Match |
| `/api/cars/[slug]/manual-data` | GET | GET, **POST** | âš ï¸ POST undocumented |
| `/api/cars/expert-reviewed` | GET | GET | âœ… Match |

#### Parts Routes (3 documented, 3 implemented)

| Route | Doc Method | Impl Methods | Status |
|-------|------------|--------------|--------|
| `/api/parts/search` | GET | GET | âœ… Match |
| `/api/parts/popular` | GET | GET | âœ… Match |
| `/api/parts/relationships` | GET | **POST** | âŒ Mismatch (doc says GET, code is POST) |

#### Users/AL Routes (4 documented, 4 implemented)

| Route | Doc Method | Impl Methods | Status |
|-------|------------|--------------|--------|
| `/api/ai-mechanic` | POST | POST, **GET** | âš ï¸ GET undocumented |
| `/api/users/[userId]/al-conversations` | GET | GET | âœ… Match |
| `/api/users/[userId]/al-conversations/[conversationId]` | GET | GET, **DELETE**, **PATCH** | âš ï¸ DELETE, PATCH undocumented |
| `/api/users/[userId]/al-credits` | GET | GET | âœ… Match |

#### VIN Routes (2 documented, 2 implemented)

| Route | Doc Method | Impl Methods | Status |
|-------|------------|--------------|--------|
| `/api/vin/decode` | POST | POST, **GET** | âš ï¸ GET undocumented |
| `/api/vin/resolve` | POST | POST | âœ… Match |

#### Internal Routes (7 documented, 7 implemented)

| Route | Doc Method | Impl Methods | Status |
|-------|------------|--------------|--------|
| `/api/internal/car-variants` | POST | POST, **GET** | âš ï¸ GET undocumented |
| `/api/internal/dyno/runs` | POST | POST, **GET** | âš ï¸ GET undocumented |
| `/api/internal/track/lap-times` | POST | POST, **GET** | âš ï¸ GET undocumented |
| `/api/internal/parts/fitments` | POST | **GET**, **PATCH** | âš ï¸ GET, PATCH undocumented (no POST!) |
| `/api/internal/knowledge/ingest` | POST | POST | âœ… Match |
| `/api/internal/maintenance/variant-overrides` | POST | POST, **GET** | âš ï¸ GET undocumented |
| `/api/internal/qa-report` | GET | GET | âœ… Match |

#### Cron Routes (3 documented, 3 implemented)

| Route | Doc Method | Impl Methods | Status |
|-------|------------|--------------|--------|
| `/api/cron/schedule-ingestion` | - | GET | âš ï¸ Method not specified in docs |
| `/api/cron/process-scrape-jobs` | - | GET, **POST** | âš ï¸ Methods not specified in docs |
| `/api/cron/youtube-enrichment` | - | GET, **POST** | âš ï¸ Methods not specified in docs |

#### Other Routes (3 documented, 3 implemented)

| Route | Doc Method | Impl Methods | Status |
|-------|------------|--------------|--------|
| `/api/contact` | POST | POST | âœ… Match |
| `/api/feedback` | POST | POST, **GET** | âš ï¸ GET undocumented |
| `/auth/callback` | GET | GET (route.js) | âœ… Match |

### ğŸš¨ Critical: Missing Route

| Route Used | Locations | Issue |
|------------|-----------|-------|
| `/api/cars?limit=200` | 5 internal pages | **Route file does not exist!** |

**Affected Files:**
1. `app/internal/knowledge/page.jsx:27`
2. `app/internal/parts-review/page.jsx:33`
3. `app/internal/lap-times/page.jsx:44`
4. `app/internal/manual-entry/page.jsx:54`
5. `app/internal/dyno/page.jsx:55`

**Impact:** All 5 internal admin pages will fail to load car dropdown data.

**Recommended Fix:** Create `/api/cars/route.js` with GET handler that returns car list.

### Summary of Undocumented Methods

| Route | Undocumented Method(s) |
|-------|------------------------|
| `/api/cars/[slug]/manual-data` | POST |
| `/api/ai-mechanic` | GET |
| `/api/users/[userId]/al-conversations/[conversationId]` | DELETE, PATCH |
| `/api/vin/decode` | GET |
| `/api/internal/car-variants` | GET |
| `/api/internal/dyno/runs` | GET |
| `/api/internal/track/lap-times` | GET |
| `/api/internal/parts/fitments` | GET, PATCH |
| `/api/internal/maintenance/variant-overrides` | GET |
| `/api/feedback` | GET |

---

## Phase 2A: Import/Export Health

**Status:** âœ… Complete  
**Scanned:** lib/, app/api/parts/, app/api/cron/, components/  
**Issues Found:** 4 (2 deprecated refs, 2 TODOs)

### Import Verification

All `@/` imports in `lib/` resolve correctly:

| Import Pattern | Source Files | Status |
|----------------|--------------|--------|
| `@/data/cars.js` | carsClient.js, alTools.js, aiMechanicService.js | âœ… Exists |
| `@/data/upgradeEducation` | alTools.js, encyclopediaData.js, educationData.js | âœ… Exists |
| `@/data/connectedTissueMatrix` | encyclopediaData.js, educationData.js, dependencyChecker.js | âœ… Exists |
| `@/data/upgradePackages.js` | dependencyChecker.js | âœ… Exists |
| `@/lib/upgrades.js` | dependencyChecker.js | âœ… Exists |
| `@/lib/embeddingUtils` | knowledgeIndexService.js, app/api/internal/knowledge/ingest | âœ… Exists |
| `./supabase.js` | partsVendorIngestionService.js, knowledgeIndexService.js | âœ… Exists |

### âœ… Deprecated File References (Resolved)

| Deprecated File | Referenced In | Status |
|-----------------|---------------|--------|
| `SOURCE_OF_TRUTH.md` | `docs/OWNER_GUIDE.md` | âœ… Fixed - Updated to point to `/docs` directory |
| `docs/data-model.md` | `docs/OWNER_GUIDE.md`, `supabase/schema.sql` | âœ… Fixed - Updated to `docs/DATABASE.md` |

**Note:** Both deprecated files have been removed from git (`D SOURCE_OF_TRUTH.md`, `D docs/data-model.md`). All references now point to current documentation.

### TODO/FIXME Markers

| File | Line | Content | Priority |
|------|------|---------|----------|
| `lib/userDataService.js` | 385 | `// TODO: Remove these after updating all consumers` | Low |
| `lib/alTools.js` | 1427 | `// TODO: Integrate with Exa API when available` | Low |

### Export Usage Verification

| Module | Exports | Usage Status |
|--------|---------|--------------|
| `lib/partsVendorIngestionService.js` | `ingestShopifyVendor`, `SHOPIFY_VENDOR_PRESETS`, `runPartsVendorIngestJob` | âœ… Used by scrapeJobService.js |
| `lib/knowledgeIndexService.js` | `ingestKnowledgeText`, `runKnowledgeIndexJob` | âœ… Used by API routes |

---

## Phase 2B: Database Schema Alignment

**Status:** âš ï¸ Issues Found  
**Tables in Code:** 47  
**Tables in DATABASE.md:** 51  
**Undocumented Tables:** 2  
**Column Mismatches:** 2

### Tables Used in Code vs DATABASE.md

#### âœ… Verified Tables (Match DATABASE.md)

| Category | Tables | Status |
|----------|--------|--------|
| Core Car Data | `cars`, `car_variants`, `car_fuel_economy`, `car_safety_data`, `car_issues`, `car_market_pricing`, `car_market_pricing_years`, `car_price_history`, `car_dyno_runs`, `car_track_lap_times`, `car_recalls`, `car_auction_results`, `car_manual_data` | âœ… |
| Parts | `parts`, `part_fitments`, `part_pricing_snapshots`, `part_relationships`, `part_brands`, `upgrade_keys`, `upgrade_packages` | âœ… |
| User Data | `user_profiles`, `user_favorites`, `user_projects`, `user_feedback`, `user_vehicles`, `user_service_logs`, `user_project_parts`, `user_compare_lists`, `user_activity` | âœ… |
| Maintenance | `vehicle_maintenance_specs`, `vehicle_service_intervals`, `vehicle_known_issues` | âœ… |
| AL/AI | `al_conversations`, `al_messages`, `al_user_credits`, `al_usage_logs`, `al_credit_purchases` | âœ… |
| Knowledge | `source_documents`, `document_chunks` | âœ… |
| YouTube | `youtube_videos`, `youtube_video_car_links`, `youtube_channels`, `youtube_ingestion_queue` | âœ… |
| Track | `track_venues`, `track_layouts` | âœ… |
| System | `scrape_jobs`, `fitment_tag_mappings`, `leads`, `car_variant_maintenance_overrides` | âœ… |

#### âš ï¸ Tables in Code NOT in DATABASE.md

| Table | Used In | Migration | Action |
|-------|---------|-----------|--------|
| `upgrade_education` | `lib/educationData.js:433,527` | `001_seed_upgrade_education.sql` | Add to DATABASE.md |
| `car_known_issues` | `lib/alTools.js:625,778` | `RUN_IN_DASHBOARD.sql` | Add to DATABASE.md |

**Note:** Both tables exist in schema and have data. DATABASE.md is simply missing documentation.

### âš ï¸ Column Mismatches (Documentation Errors)

#### `part_relationships` Table

| Column | DATABASE.md Says | Actual Schema | Code Uses |
|--------|------------------|---------------|-----------|
| FK to part A | `part_id_a` | `part_id` | `part_id` âœ… |
| FK to part B | `part_id_b` | `related_part_id` | `related_part_id` âœ… |
| Relation type | `relationship_type` | `relation_type` | `relation_type` âœ… |

**Fix Required:** Update DATABASE.md line 152 to use correct column names.

#### `document_chunks` Table

| Column | DATABASE.md Says | Actual Schema | Code Uses |
|--------|------------------|---------------|-----------|
| FK to source | `source_document_id` | `document_id` | `document_id` âœ… |

**Fix Required:** Update DATABASE.md line 318 to use `document_id`.

### Priority Table Deep Dive

#### `parts` Table Columns Verified

```
âœ… id, name, brand_name, part_number, category, description
âœ… quality_tier, street_legal, is_active, source_urls
âœ… attributes (JSONB), confidence, brand_id
```

#### `part_fitments` Table Columns Verified

```
âœ… id, part_id, car_id, car_variant_id
âœ… fitment_notes, requires_tune, install_difficulty
âœ… estimated_labor_hours, verified, confidence
âœ… source_url, metadata
```

#### `part_pricing_snapshots` Table Columns Verified

```
âœ… id, part_id, vendor_name, vendor_url, product_url
âœ… currency, price_cents, in_stock, recorded_at, metadata
```

#### `source_documents` / `document_chunks` Columns Verified

```
source_documents:
âœ… id, source_type, source_url, source_title, license
âœ… retrieved_at, checksum, raw_text, raw_json, metadata

document_chunks:
âœ… id, document_id (NOT source_document_id), car_id, car_slug
âœ… chunk_index, chunk_text, chunk_tokens, topic
âœ… embedding_model, embedding, metadata
```

---

## Phase 3A: Parts Catalog Integration

**Status:** âœ… Complete  
**Verified:** API â†’ Service â†’ Database â†’ Frontend

### Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PARTS CATALOG DATA FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚  Tuning Shop     â”‚                                                       â”‚
â”‚  â”‚  (page.jsx)      â”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚  UpgradeCenter   â”‚â—„â”€â”€â”€ Parts Finder (Beta)                               â”‚
â”‚  â”‚  (component)     â”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚           â”‚                           â”‚                                     â”‚
â”‚           â–¼                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ /api/parts/searchâ”‚       â”‚ /api/parts/      â”‚                            â”‚
â”‚  â”‚ (GET)            â”‚       â”‚ relationships    â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ (POST)           â”‚                            â”‚
â”‚           â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚           â”‚                          â”‚                                      â”‚
â”‚           â–¼                          â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ Tables:          â”‚       â”‚ Tables:          â”‚                            â”‚
â”‚  â”‚ â€¢ parts          â”‚       â”‚ â€¢ part_          â”‚                            â”‚
â”‚  â”‚ â€¢ part_fitments  â”‚       â”‚   relationships  â”‚                            â”‚
â”‚  â”‚ â€¢ part_pricing_  â”‚       â”‚ â€¢ parts          â”‚                            â”‚
â”‚  â”‚   snapshots      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚  â”‚ â€¢ cars           â”‚                                                       â”‚
â”‚  â”‚ â€¢ car_variants   â”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚ SavedBuilds      â”‚                                                       â”‚
â”‚  â”‚ Provider         â”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚ userDataService  â”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚ Tables:          â”‚                                                       â”‚
â”‚  â”‚ â€¢ user_projects  â”‚                                                       â”‚
â”‚  â”‚ â€¢ user_project_  â”‚                                                       â”‚
â”‚  â”‚   parts          â”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Layer Verification

| Route | Method | Doc Status | Error Handling | Tables Used |
|-------|--------|------------|----------------|-------------|
| `/api/parts/search` | GET | âœ… Matches API.md | âœ… try/catch + logging | parts, part_fitments, part_pricing_snapshots, cars, car_variants |
| `/api/parts/popular` | GET | âœ… Matches API.md | âœ… try/catch + logging | cars, part_fitments, parts, part_pricing_snapshots |
| `/api/parts/relationships` | **POST** | âŒ API.md says GET | âœ… try/catch + logging | part_relationships, parts |

### Response Shape Validation

**`/api/parts/search` Response:**
```json
{
  "query": "intake",
  "carSlug": "718-cayman-gt4",
  "carVariantKey": null,
  "count": 5,
  "results": [
    {
      "id": "uuid",
      "name": "Cold Air Intake",
      "brand_name": "AFE",
      "part_number": "54-12202",
      "category": "intake",
      "fitment": { "verified": true, "requires_tune": false, "confidence": 0.95 },
      "latest_price": { "price_cents": 35000, "vendor_name": "MAPerformance" }
    }
  ]
}
```
âœ… Matches API.md response shape

### Frontend Integration

| Component | Parts API Usage | Loading State | Error State |
|-----------|----------------|---------------|-------------|
| `UpgradeCenter.jsx` | `/api/parts/search`, `/api/parts/relationships` | âœ… `partsLoading` | âœ… `partsError` |
| `SavedBuildsProvider.jsx` | `userDataService` â†’ `user_project_parts` | âœ… `isLoading` | âœ… Error handling |

### Build Persistence Flow

```
UpgradeCenter (selectedParts)
    â”‚
    â–¼
SavedBuildsProvider.saveBuild({ selectedParts })
    â”‚
    â–¼
userDataService.saveUserBuild()
    â”‚
    â–¼
user_projects (main record)
    â”‚
    â–¼
user_project_parts (delete + insert pattern)
```

### Issues Found

| Issue | Severity | Location |
|-------|----------|----------|
| API.md says GET for `/api/parts/relationships` but code is POST | High | Already tracked as HIGH-003 |

---

## Phase 3B: AL Tools Verification

**Status:** âœ… Complete  
**Tools Verified:** 15/15  
**Schema Matches:** 15/15

### Tool Inventory

| # | Tool Name | Exists | Schema Match | Tier Access | DB Tables/RPCs |
|---|-----------|--------|--------------|-------------|----------------|
| 1 | `search_cars` | âœ… | âœ… | Free+ | cars (via RPC or local data) |
| 2 | `get_car_details` | âœ… | âœ… | Free+ | cars, car_issues, car_known_issues |
| 3 | `get_car_ai_context` | âœ… | âœ… | Free+ | RPC: `get_car_ai_context` |
| 4 | `get_expert_reviews` | âœ… | âœ… | Collector+ | youtube_video_car_links, youtube_videos |
| 5 | `get_known_issues` | âœ… | âœ… | Collector+ | car_issues, car_known_issues |
| 6 | `compare_cars` | âœ… | âœ… | Collector+ | local car data |
| 7 | `search_encyclopedia` | âœ… | âœ… | Collector+ | lib/encyclopediaData.js |
| 8 | `get_upgrade_info` | âœ… | âœ… | Collector+ | data/upgradeEducation.js |
| 9 | `search_forums` | âœ… | âœ… | Collector+ | Placeholder (returns suggestions) |
| 10 | `search_parts` | âœ… | âœ… | Collector+ | parts, part_fitments, part_pricing_snapshots |
| 11 | `get_maintenance_schedule` | âœ… | âœ… | Collector+ | RPCs: `get_car_maintenance_summary`, `get_car_maintenance_summary_variant` |
| 12 | `search_knowledge` | âœ… | âœ… | Collector+ | RPC: `search_document_chunks` (uses `document_id`) |
| 13 | `get_track_lap_times` | âœ… | âœ… | Collector+ | RPC: `get_car_track_lap_times` â†’ car_track_lap_times |
| 14 | `get_dyno_runs` | âœ… | âœ… | Collector+ | RPC: `get_car_dyno_runs` â†’ car_dyno_runs |
| 15 | `recommend_build` | âœ… | âœ… | Tuner only | parts, part_fitments, part_pricing_snapshots |

### Enhanced Tools Deep-Dive

#### `get_maintenance_schedule` âœ…

**Variant Override Support:**
```javascript
if (car_variant_key) {
  const { data } = await supabase.rpc('get_car_maintenance_summary_variant', { p_variant_key: car_variant_key });
}
// Falls back to:
const { data } = await supabase.rpc('get_car_maintenance_summary', { p_car_slug: car_slug });
```

**RPC Chain:**
- `get_car_maintenance_summary_variant(p_variant_key)` â†’ checks `car_variant_maintenance_overrides` â†’ falls back to `vehicle_maintenance_specs`
- `get_car_maintenance_summary(p_car_slug)` â†’ directly queries `vehicle_maintenance_specs`

#### `search_parts` âœ…

**Returns fitment + pricing:**
```javascript
results: rows.map(r => ({
  part: { ...r.parts, latest_price: priceByPartId.get(r.parts.id) },
  fitment: { notes, requires_tune, install_difficulty, verified, confidence, source_url }
}))
```

**Tables queried:** parts, part_fitments, part_pricing_snapshots

#### `get_track_lap_times` âœ…

**RPC:** `get_car_track_lap_times(p_car_slug, p_limit)`

**Source Table:** `car_track_lap_times`

**Joins:** track_venues, track_layouts, source_documents

#### `get_dyno_runs` âœ…

**RPC:** `get_car_dyno_runs(p_car_slug, p_limit, p_include_curve)`

**Source Table:** `car_dyno_runs`

**Joins:** source_documents (for provenance)

#### `search_knowledge` âœ…

**Process:**
1. Generate embedding via OpenAI API
2. Call RPC: `search_document_chunks(p_embedding, p_car_id, p_limit)`
3. Returns chunks with similarity scores and source URLs

**Source Table:** `document_chunks` (column is `document_id`, NOT `source_document_id` as docs say)

### Tier Restrictions Verification

| Tier | Tools Available | Config Location |
|------|-----------------|-----------------|
| Free | 3 tools | `alConfig.js:100-104` |
| Collector | 14 tools | `alConfig.js:135-150` |
| Tuner | 15 tools (all) | `alConfig.js:187` |

**Verified in `alConfig.js`:**
```javascript
free: { toolAccess: ['search_cars', 'get_car_details', 'get_car_ai_context'] },
collector: { toolAccess: ['search_cars', ...all except recommend_build] },
tuner: { toolAccess: 'all' }
```

### Tool Caching

| Tool | TTL | Cache Key |
|------|-----|-----------|
| `get_car_ai_context` | 2 min | `{scope}:get_car_ai_context:{params}` |
| `search_knowledge` | 5 min | `{scope}:search_knowledge:{params}` |
| `get_track_lap_times` | 10 min | `{scope}:get_track_lap_times:{params}` |
| `get_dyno_runs` | 10 min | `{scope}:get_dyno_runs:{params}` |

### Issues Found

| Issue | Severity | Location | Status |
|-------|----------|----------|--------|
| DATABASE.md says `source_document_id` but column is `document_id` | High | `docs/DATABASE.md:318` | Already tracked as HIGH-005 |

---

## Phase 4: Cron & Background Jobs Verification

**Status:** âœ… Complete  
**Crons in vercel.json:** 4 entries (3 unique routes)  
**Route Files:** 3  
**Auth Issues:** 2

### Cron Inventory

#### vercel.json Configuration

| Path | Schedule | Cron Expression | Purpose |
|------|----------|-----------------|---------|
| `/api/cron/process-scrape-jobs?max=3&delay=15000` | Every 15 min | `*/15 * * * *` | Incremental job processing |
| `/api/cron/process-scrape-jobs?max=10&delay=5000` | Sun 3am UTC | `0 3 * * 0` | Weekly batch processing |
| `/api/cron/schedule-ingestion` | Sun 2am UTC | `0 2 * * 0` | Queue parts + knowledge jobs |
| `/api/cron/youtube-enrichment` | Mon 4am UTC | `0 4 * * 1` | Weekly video discovery + AI |

**Note:** API.md says schedules are "Daily/Hourly/Every 6h" but actual schedules are different (see MED-006).

### Route Verification

| Route | File Exists | GET | POST | GET Auth | POST Auth |
|-------|-------------|-----|------|----------|-----------|
| `/api/cron/process-scrape-jobs` | âœ… | âœ… | âœ… | âœ… CRON_SECRET + x-vercel-cron | âš ï¸ CRON_SECRET only |
| `/api/cron/schedule-ingestion` | âœ… | âœ… | âŒ | âœ… CRON_SECRET + x-vercel-cron | N/A |
| `/api/cron/youtube-enrichment` | âœ… | âœ… | âœ… | âš ï¸ CRON_SECRET only | âš ï¸ Delegates to GET |

### Security Verification

#### âœ… Secure: `schedule-ingestion`

```javascript
function isAuthorized(request) {
  const authHeader = request.headers.get('authorization');
  if (CRON_SECRET && authHeader === `Bearer ${CRON_SECRET}`) return true;
  const vercelCron = request.headers.get('x-vercel-cron');
  return vercelCron === 'true';
}
```

- Checks BOTH Bearer token AND Vercel cron header
- Properly handles both manual triggers and Vercel-scheduled runs

#### âœ… Secure: `process-scrape-jobs` GET

```javascript
if (CRON_SECRET && authHeader !== `Bearer ${CRON_SECRET}`) {
  const vercelCron = request.headers.get('x-vercel-cron');
  if (vercelCron !== 'true') {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
}
```

- Falls back to x-vercel-cron header if Bearer fails
- Used by Vercel cron (both 15-min and weekly schedules)

#### âš ï¸ Issue: `process-scrape-jobs` POST

```javascript
if (CRON_SECRET && authHeader !== `Bearer ${CRON_SECRET}`) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
```

- POST is for manual triggers only (schedule_refresh, cleanup, stats)
- Missing x-vercel-cron fallback, but POST is not scheduled in vercel.json
- **Risk:** Low - requires CRON_SECRET for manual operations

#### âš ï¸ Issue: `youtube-enrichment` GET (HIGH-006)

```javascript
if (CRON_SECRET && authHeader !== `Bearer ${CRON_SECRET}`) {
  return Response.json({ error: 'Unauthorized' }, { status: 401 });
}
```

- Missing x-vercel-cron header check
- **Risk:** If CRON_SECRET is not set, auth passes (condition is `CRON_SECRET && ...`)
- **Impact:** Vercel cron may fail to authenticate if only using header
- **Fix Required:** Add x-vercel-cron fallback like other routes

### Service Dependency Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CRON JOB ARCHITECTURE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    VERCEL CRON SCHEDULER                               â”‚ â”‚
â”‚  â”‚    (vercel.json â†’ Triggers GET with x-vercel-cron: true header)        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                    â”‚                    â”‚                       â”‚
â”‚           â–¼                    â–¼                    â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ process-     â”‚    â”‚ schedule-    â”‚    â”‚ youtube-       â”‚                 â”‚
â”‚  â”‚ scrape-jobs  â”‚    â”‚ ingestion    â”‚    â”‚ enrichment     â”‚                 â”‚
â”‚  â”‚ (every 15m)  â”‚    â”‚ (Sun 2am)    â”‚    â”‚ (Mon 4am)      â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                   â”‚                    â”‚                          â”‚
â”‚         â–¼                   â–¼                    â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                          â”‚
â”‚  â”‚       scrapeJobService.js        â”‚            â”‚                          â”‚
â”‚  â”‚  â€¢ processPendingJobs()          â”‚            â”‚                          â”‚
â”‚  â”‚  â€¢ schedulePartsVendorIngestJobs â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚  â”‚  â€¢ createJob()                   â”‚            â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                          â”‚
â”‚                 â”‚                                â”‚                          â”‚
â”‚                 â–¼                                â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                          â”‚
â”‚  â”‚         scrape_jobs table        â”‚            â”‚                          â”‚
â”‚  â”‚  â€¢ id, car_slug, job_type        â”‚            â”‚                          â”‚
â”‚  â”‚  â€¢ status, priority              â”‚            â”‚                          â”‚
â”‚  â”‚  â€¢ scheduled_for, job_payload    â”‚            â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                          â”‚
â”‚                                                  â”‚                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â–¼                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   YouTube Pipeline (Standalone)  â”‚    â”‚   Job Type Handlers          â”‚   â”‚
â”‚  â”‚  â€¢ youtube_channels              â”‚    â”‚  â€¢ PARTS_VENDOR_INGEST       â”‚   â”‚
â”‚  â”‚  â€¢ youtube_videos                â”‚    â”‚    â†’ partsVendorIngestion    â”‚   â”‚
â”‚  â”‚  â€¢ youtube_video_car_links       â”‚    â”‚  â€¢ KNOWLEDGE_INDEX           â”‚   â”‚
â”‚  â”‚  â€¢ cars (consensus update)       â”‚    â”‚    â†’ knowledgeIndexService   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â€¢ FULL_ENRICH/PRICING_ONLY  â”‚   â”‚
â”‚                                          â”‚    â†’ dataAggregator          â”‚   â”‚
â”‚  External APIs:                          â”‚    â†’ enrichedDataService     â”‚   â”‚
â”‚  â€¢ YouTube Data API                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â€¢ Anthropic (AI processing)                                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Job Type Matrix

| Job Type | Source | Tables Written | Trigger |
|----------|--------|----------------|---------|
| `PARTS_VENDOR_INGEST` | schedule-ingestion | `parts`, `part_fitments`, `part_pricing_snapshots` | Weekly |
| `KNOWLEDGE_INDEX` | schedule-ingestion | `source_documents`, `document_chunks` | Weekly |
| `FULL_ENRICH` | Manual/stale refresh | `car_fuel_economy`, `car_safety_data`, `car_market_pricing` | Manual |
| `PRICING_ONLY` | Manual | `car_market_pricing` | Manual |
| `SAFETY_ONLY` | Manual | `car_safety_data` | Manual |
| YouTube Discovery | youtube-enrichment | `youtube_videos`, `youtube_video_car_links` | Weekly |
| YouTube AI Processing | youtube-enrichment | `youtube_videos`, `youtube_video_car_links`, `cars` | Weekly |

### Error Handling Verification

| Route | try/catch | Logging | Status Codes | Retry Logic |
|-------|-----------|---------|--------------|-------------|
| process-scrape-jobs GET | âœ… | âœ… `console.log/error` | 401, 500 | âœ… In service |
| process-scrape-jobs POST | âœ… | âœ… `console.error` | 400, 401, 500 | N/A |
| schedule-ingestion | âœ… | âœ… `console.error` | 401, 500 | N/A |
| youtube-enrichment | âœ… | âœ… `console.log/error` | 401, 500 | âŒ No retry |

### scrapeJobService Retry Logic

```javascript
// Exponential backoff: 2, 4, 8 minutes
const retryDelay = Math.pow(2, currentAttempt) * 60 * 1000;
const maxAttempts = job.max_attempts || 3;
```

- Jobs auto-retry up to 3 times on failure
- Backoff: 2min â†’ 4min â†’ 8min
- Failed jobs marked with `error_message` for debugging

### Phase 4 Issues Found

| Issue | Severity | Location | Status |
|-------|----------|----------|--------|
| youtube-enrichment missing x-vercel-cron check | High | `app/api/cron/youtube-enrichment/route.js:47` | NEW: HIGH-006 |
| API.md cron schedules incorrect | Medium | `docs/API.md:406-410` | NEW: MED-006 |
| process-scrape-jobs POST missing fallback | Low | `app/api/cron/process-scrape-jobs/route.js:79` | NEW: MED-007 |

### Recommended Fixes

#### HIGH-006 Fix: youtube-enrichment auth

```javascript
// Replace lines 44-49 with:
export async function GET(request) {
  const authHeader = request.headers.get('authorization');
  if (CRON_SECRET && authHeader !== `Bearer ${CRON_SECRET}`) {
    const vercelCron = request.headers.get('x-vercel-cron');
    if (vercelCron !== 'true') {
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }
  }
  // ... rest of handler
}
```

#### MED-006 Fix: Update API.md

| Route | Current Doc | Actual Schedule |
|-------|-------------|-----------------|
| schedule-ingestion | "Daily" | Weekly (Sun 2am) |
| process-scrape-jobs | "Hourly" | Every 15 min + Weekly batch |
| youtube-enrichment | "Every 6h" | Weekly (Mon 4am) |

---

## DATABASE.md Updates Required

The following updates are needed to align DATABASE.md with the actual schema:

### 1. Add Missing Tables

**Add `upgrade_education` table documentation:**
```markdown
### `upgrade_education` â€” Upgrade educational content
| Status | **49 rows** |
|--------|------------|
| **Purpose** | Educational content about upgrades for Encyclopedia |
| **Key Fields** | `key`, `slug`, `name`, `category`, `description`, `difficulty`, `skill_required`, `estimated_time`, `tools_needed`, `pros`, `cons`, `tips` |
| **Used By** | Encyclopedia, Tuning Shop |
```

**Add `car_known_issues` table documentation:**
```markdown
### `car_known_issues` â€” Legacy known issues
| Status | **89 rows** |
|--------|------------|
| **Purpose** | Known problems per car (legacy, may duplicate vehicle_known_issues) |
| **Key Fields** | `car_slug`, `title`, `severity`, `description`, `fix`, `cost_estimate` |
| **Used By** | AL `get_known_issues` tool |
```

### 2. Fix Column Names

**`part_relationships` (line ~152):**
- Change `part_id_a` â†’ `part_id`
- Change `part_id_b` â†’ `related_part_id`
- Change `relationship_type` â†’ `relation_type`

**`document_chunks` (line ~318):**
- Change `source_document_id` â†’ `document_id`

---

## Consolidated Action Items

| ID | Priority | Description | Phase | Status |
|----|----------|-------------|-------|--------|
| CRIT-001 | ğŸ”´ Critical | Create `/api/cars/route.js` for car list endpoint | 1B | Open |
| HIGH-001 | ğŸŸ  High | Fix broken link in `app/internal/qa/page.jsx:127` | 1A | Open |
| HIGH-002 | ğŸŸ  High | Fix broken link in `app/garage/compare/page.jsx:163` | 1A | Open |
| HIGH-003 | ğŸŸ  High | Fix API.md: `/api/parts/relationships` is POST not GET | 1B | Open |
| HIGH-004 | ğŸŸ  High | Fix DATABASE.md: `part_relationships` column names | 2B | Open |
| HIGH-005 | ğŸŸ  High | Fix DATABASE.md: `document_chunks.document_id` | 2B | Open |
| HIGH-006 | ğŸŸ  High | Add x-vercel-cron check to youtube-enrichment | 4 | Open |
| MED-001 | ğŸŸ¡ Medium | Document 13 undocumented API methods in API.md | 1B | Open |
| MED-002 | ğŸŸ¡ Medium | Add `upgrade_education` table to DATABASE.md | 2B | Open |
| MED-003 | ğŸŸ¡ Medium | Add `car_known_issues` table to DATABASE.md | 2B | Open |
| MED-004 | ğŸŸ¡ Medium | Remove `SOURCE_OF_TRUTH.md` refs from OWNER_GUIDE.md | 2A | âœ… Resolved |
| MED-005 | ğŸŸ¡ Medium | Remove `docs/data-model.md` ref from OWNER_GUIDE.md | 2A | âœ… Resolved |
| MED-006 | ğŸŸ¡ Medium | Update API.md cron schedules to match vercel.json | 4 | Open |
| MED-007 | ğŸŸ¡ Medium | Add x-vercel-cron fallback to process-scrape-jobs POST | 4 | Open |
| LOW-001 | ğŸŸ¢ Low | Verify `/encyclopedia#systems` anchor exists | 1A | Open |
| LOW-002 | ğŸŸ¢ Low | Address TODO in `lib/userDataService.js:385` | 2A | Open |
| LOW-003 | ğŸŸ¢ Low | Address TODO in `lib/alTools.js:1427` (Exa API) | 2A | Open |

---

## Changelog

| Date | Phase | Change |
|------|-------|--------|
| 2024-12-14 | - | Audit tracking file created |
| 2024-12-14 | 1A | Internal link verification complete - 2 broken links found |
| 2024-12-14 | 1B | API route verification complete - 1 critical missing route, 13 undocumented methods |
| 2024-12-14 | 2A | Import/export health check complete - 2 deprecated refs, 2 TODOs found |
| 2024-12-14 | 2B | Database schema alignment complete - 2 undocumented tables, 2 column doc errors |
| 2024-12-14 | 3A | Parts catalog integration verified - all flows correct, 1 doc mismatch (POST vs GET) |
| 2024-12-14 | 3B | AL tools verification complete - all 15 tools exist and match schemas |
| 2024-12-14 | 4 | Cron & background jobs verified - 2 auth gaps found, 1 doc mismatch |
